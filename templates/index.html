<!DOCTYPE html>
<head>
  <title>DFU-file site</title>

  <style>
    body{
      background-color: rgb(215, 230, 240);
    }
    table{
      background-color: white;
    }

    #miribogi_div{
      display: inline;

      padding: 5px;

      font-weight: bold;
    }

    #miribogi_div:hover{
      cursor: pointer;
    }

    #nebo_miri_buttons{
      margin-top: 20px;
    }

    #insert_link, #miribogi_div, #final_link{
      border: 2px solid black;
      color: black;
      text-decoration: none;
      padding: 7px;
      background-color: #ffec5d;
      font-weight: bold;
      font-size: 20px;

      margin: 0 10px;
    }

    #wait_input{
      border: 2px solid black;
      background-color: #ffec5d;
      font-weight: bold;
      font-size: 20px;
      padding: 7px;

      margin: 0 10px;
    }

    #wait_input:hover{
      cursor: pointer;
    }

    .modal-wrapper{
        position: fixed;
        top: -10%;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }

    .modal{
        background: white;
        padding: 24px 16px;
        border: 5px solid rgb(175, 190, 220);
        border-radius: 4px;
        width: 1250px;
        height: 350px;
        overflow: auto;

        opacity: 0.95;
        color: black;
    }

    .close-wrapper{
        position: absolute;
        right: 0;
        text-align: right;
    }

    #close1{
      background-color: rgb(239, 239, 239);
      border: 2px solid black;
      padding: 7px;
      font-weight: bold;
      font-size: 20px;
    }

    #close1:hover, #nebonegi_button:hover{
      cursor: pointer;
    }

    #sticky_div{
      position: sticky;
      display: flex;
      bottom: 0;

      margin-top: 25px;
    }

    #logo{
      position: absolute;
      top: 0;
      left: 0;
      margin: 20px 30px;

      width: 200px;
      height: 59.3px
    }

    .star{
      width: 34px;
    }

    .pin{
      width: 24px;
      margin-right: 10px;
    }

    #login_register{
      position: absolute;
      top: 30px;
      right: 40px;
    }

    #nebonegi_button{
      background-color: #ffec5d;
      border: 2px solid black;
      padding: 7px;
      font-weight: bold;
      font-size: 20px;
    }

    *{
      font-family: 'Gowun Dodum', sans-serif;
    }

    #readme p{
      font-size : 19px;
    }

    #logout:hover{
      cursor: pointer;
    }
  </style>

  <!--    GOOGLE FONTS LINK   -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
</head>
<body>
  <a href="{% url 'stdisplay' %}"><img id="logo" src="/static/img/robomation_logo.png" alt="로고"></a>
  <center>
    <h1>DFU 파일 관리 사이트</h1>
    <div id="login_register">
      <!-- 로그인 했을 경우 "로그아웃" 띄우고, 로그아웃 했을 경우 "로그인"과 "회원가입" 띄우기 -->
      {% if user.is_authenticated %}
      <span>현재 접속 ID : <strong>{{user}}</strong> 님</span>　 |　
      <a style="color: #00549f; text-decoration:none; font-weight: bold;" href="{% url 'logout' %}">로그아웃</a>　 |　
      <form style="display: inline;" method="post">
        {% csrf_token %}
        <input style="color: white; font-size: 15px; background-color: #00549f; font-weight: bold; padding: 5px 10px;" id="logout" name="logout" type="submit" value="Admin 로그아웃"/>
      </form>
      {% else %}
      <a style="color: #00549f; text-decoration:none; font-weight: bold;" href="{% url 'login' %}">로그인</a>　|　
      <a style="color: #00549f; text-decoration:none; font-weight: bold;" href="{% url 'register' %}">회원가입</a>
      {% endif %}
    </div>
    <hr>
    <br>
    <!-- 로그인 했을 경우에 이하 코드 전체를 프론트단에서 보이게 하기 -->
    {% if user.is_authenticated %}
    <br>
    <form method="post">
        {% csrf_token %}
    <table border="1">
      <tr>
        <th></th>
        <th>제품 구분</th>
        <th>등록 일자</th>
        <th>Device Name</th>
        <th>Service UUID</th>
        <th>Product ID</th>
        <th>Device ID</th>
        <th>DFU File Name</th>
        <th>DFU CRC32</th>
        <th>DFU File 다운로드</th>
        <th>Image Name</th>
        <th>Image 다운로드</th>
      </tr>
      <!-- crudstudent 모델에 저장된 데이터들을 반복문을 통해 모두 불러오기 -->
      {% for displayst in crudstudent %}
      <tr>
        <td><input type="checkbox" name="check" value="{{displayst.id}}"></td>
        <td>{{displayst.name_ko}}</td>
        <!-- DateTimeField에 저장된 값 뒤에 |date:'Y-m-d-H:i' 와 같이 작성하여 필터링 -->
        <td>{{displayst.time|date:'Y-m-d-H:i'}}</td>
        <td>{{displayst.name_en}}</td>
        <td>{{displayst.service}}</td>
        <td>{{displayst.product}}</td>
        <td>{{displayst.device}}</td>
        <td>{{displayst.uploadedFile}}</td>
        <td>{{displayst.crc}}</td>
        <td><a style="color:blue;" href="{{displayst.uploadedFile.url}}" download="">{{displayst.uploadedFile}}</a></td>
        <td>{{displayst.imageFile}}</td>
        <td><a style="color:blue;" href="{{displayst.imageFile.url}}" download="">{{displayst.imageFile}}</a></td>

        <td><a style="color:#ff6289; text-decoration: none; font-weight: bold;" class="ee" href="/Edit/{{displayst.id}}" >수정</a></td>
        <td><a style="color:#ff6289; text-decoration: none; font-weight: bold;" class="dd1" href="/Delete/{{displayst.id}}">삭제</a></td>
      </tr>
      {% endfor %}
      <tr>
      </tr>
    </table>

    <div id="nebo_miri_buttons">
        <a id="insert_link" href="{% url 'stinsert'%}"> 추가하기</a>
        <input id="wait_input" type="submit" value="대기하기"/>
        <div id="miribogi_div">미리보기</div>
        <a id="final_link" href="{% url 'stfinal'%}">최종화면</a>
    </div>

    </form>

  </center>
  <br>
  <div id="readme">
    <hr>
    <h2><img src="/static/img/star.png" class="star" alt="별"> 기능 소개</h2>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>추가하기 -</strong> <strong>메인 페이지의 DB</strong> 테이블에 제품을 새로 등록</p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>대기하기 -</strong> 선택한 데이터를 <strong>미리보기 DB</strong>에 제출</p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>미리보기 -</strong> 최종화면의 데이터와 가장 마지막으로 대기하기한 1개의 데이터를 모두 미리 보여줌</p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>내보내기 -</strong> 미리보기 안에 있는 내보내기 버튼으로서, 마지막으로 대기하기한 데이터를 <strong>최종화면 DB</strong>에 등록</p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>최종화면 -</strong> 최종적으로 내보낸 데이터들을 텍스트 형식으로 새 창에 보여줌</p>
    <hr>
    <h2><img src="/static/img/star.png" class="star" alt="별"> 이용 순서</h2>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong style="color:#ff6289;">추가하기</strong>(생략가능)<strong> → <span style="color: #ff6289;">대기하기</span></strong>(데이터 선택 후)<strong> → <span style="color: #ff6289;">미리보기</span> → <span style="color: #ff6289;">내보내기</span> → <span style="color: #ff6289;">최종화면</span></strong></p>
    <hr>
    <h2><img src="/static/img/star.png" class="star" alt="별"> 유의 사항</h2>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>"대기하기"</strong>와 <strong>"내보내기"</strong>는 <strong>1개씩만</strong> 가능</p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> <strong>아무것도 선택하지 않고 "대기하기"</strong>를 누를 경우 완료 문구는 뜨지만, 실제로 대기하기 되지는  않음</p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> 미리보기 안에 <strong>"대기"</strong>에 해당하는 데이터는 <strong>가장 최근에 "대기하기"한 항목임</strong></p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> ┗> 대기를 내보내기 하더라도 <strong>"대기"</strong>는 바뀌지 않음<strong>(새로 다른 것을 "대기하기"해야 바뀜)</strong></p>
    <p><img src="/static/img/pin.png" class="pin" alt="핀"> 사이트 이용 종료 시 보안을 위해 <strong>"Admin 로그아웃"</strong> 먼저 클릭 후, 그 옆에 있는 <strong>"로그아웃"</strong> 클릭하기</p>
  </div>
  <br>

  <!-- 특정 버튼 선택할 시에만 나타나는 모달창 구성 -->
  <div class="modal-wrapper" id="modal" style="display: none;">
    <div class="modal">
      <div><strong>&lt최종화면 미리보기&gt</strong><strong style="color: #00549f; margin-left: 10px;">(대기에 해당하는 데이터는 가장 최근에 "대기하기"한 항목)</strong></div>
      <div>
        <!-- zebal 모델에 저장된 데이터들을 반복문을 통해 모두 불러오기. zebal은 최종화면 DB라고 생각하면 됨. -->
        {% for i in zebal%}
        <p><a style="color:#ff6289; text-decoration: none; font-weight: bold;" class="dd2" href="/Delete2/{{i.id}}">삭제</a> - {{i.name_ko2}},{{i.time2|date:'Y-m-d-H:i'}},{{i.name_en2}},{{i.service2}},{{i.product2}},{{i.device2}},{{i.uploadedFile2}},{{i.crc2}},<a style="color:blue;" href="{{i.uploadedFile2.url}}" download="">{{i.uploadedFile2}}</a>,{{i.imageFile2}},<a style="color:blue;" href="{{i.imageFile2.url}}" download="">{{i.imageFile2}}</a></p>
        {% endfor %}
      </div>
      <hr>
      <!-- views.py에서 넘겨준 z값을 불러옴. z는 zebal 모델에 저장된 가장 마지막 인텍스의 데이터임. -->
      <div><strong style="color: #00549f;">대기</strong> - {{z.name_ko3}},{{z.time3|date:'Y-m-d-H:i'}},{{z.name_en3}},{{z.service3}},{{z.product3}},{{z.device3}},{{z.uploadedFile3}},{{z.crc3}},<a style="color:blue;" href="{{z.uploadedFile3.url}}" download="">{{z.uploadedFile3}}</a>,{{z.imageFile3}},<a style="color:blue;" href="{{z.imageFile3.url}}" download="">{{z.imageFile3}}</a></div>

      <div id="sticky_div">
         <form method="post" id="html_form" onsubmit="return false">
          {% csrf_token %}
          <div id="nebonegi_wrapper"><input type="submit" value="내보내기" name="nebonegi_button" id="nebonegi_button"/></div>
        </form>
        <div class="close-wrapper">
          <button id="close1">닫기</button>
        </div>
      </div>

    </div>
  </div>

  {% else %}
  <p style="font-size: 18px;">로그인이 필요한 서비스입니다.</p>
  {% endif %}

</body>

<script>
    nButton = document.getElementById("nebonegi_button");
    html_form = document.getElementById("html_form");
    nButton.onclick = () => {
      pw = prompt("내보내려면 암호를 입력하세요.");

      // 암호 입력 시 html_form의 속성 중 하나인 onsubmit을 true로 바꿈(원래는 false였음)
      if(pw=={{EXPORT_P}}){
          html_form.setAttribute('onsubmit','return true');
          confirm("내보내기 성공!")
      }else{
          alert("암호가 일치하지 않습니다.")
      }
    }



     const open1 = document.getElementById("miribogi_div");
     const modal = document.querySelector("#modal");
     open1.onclick = () => {
         modal.style.display = "flex";
     }

     const close1 = document.getElementById("close1");
     close1.onclick = () => {
         modal.style.display = "none";
     }



    const wait_input = document.getElementById("wait_input");
    wait_input.onclick = () => {
        confirm("대기하기 완료!")
    }


    /*
       1. querySelectorAll을 통해 클래스명이 'ee'인 것들을 모두 저장
       2. forEach를 통해 클래스 'ee'인 것들의 각각 하나씩에 addEventListener를 할당
       3. click 시 prompt로 암호 입력하도록 구현
       4. event.target을 통해 해당 event가 발생한 값의 속성중 "href"를 ""로 저장 -> 아무 변화가 일어나지 않도록 하기 위해
    */
    const edit_link = document.querySelectorAll('.ee');
    edit_link.forEach(el => el.addEventListener('click', event => {
        pw1 = prompt("수정하려면 암호를 입력하세요.");
        if(pw1=={{EDIT_P}}){
            confirm("인증 성공!")
        }else{
            alert("암호가 일치하지 않습니다.")
            event.target.setAttribute("href", "");
        }
    }));

    const delete_link1 = document.querySelectorAll('.dd1');
    delete_link1.forEach(el => el.addEventListener('click', event => {
        pw2 = prompt("삭제하려면 암호를 입력하세요.");
        if(pw2=={{DELETE_P}}){
            confirm("인증 성공!")
        }else{
            alert("암호가 일치하지 않습니다.")
            event.target.setAttribute("href", "");
        }
    }));

    const delete_link2 = document.querySelectorAll('.dd2');
    delete_link2.forEach(el => el.addEventListener('click', event => {
        pw2 = prompt("삭제하려면 암호를 입력하세요.");
        if(pw2=={{DELETE_P}}){
            confirm("인증 성공!")
        }else{
            alert("암호가 일치하지 않습니다.")
            event.target.setAttribute("href", "");
        }
    }));

    /*
      1. 삭제할 경우 주소 뒤에 /Delete/뭐시기가 붙음으로 인해 기본 주소에 불러와지는 값들이나 적용되는 메소드들에 오류 발생
      2. 따라서 삭제하더라도 삭제 기능은 구현하되, 주소는 기본 주소로 설정하기 위해 아래와 같은 코드를 작성함
      3. 삭제할 경우 views.py의 delete_flag를 1로 설정하고, 자바스크립트에서도 조건문을 통해 이를 이용하여 현재 주소를 기본 페이지로 설정
    */
    if({{delete_flag}} == 1){
        window.location.href="{% url 'stdisplay' %}";
    }

    const logout = document.getElementById("logout");
    logout.onclick = () => {
        confirm("Admin 로그아웃 성공!")
    }

</script>
</html>
